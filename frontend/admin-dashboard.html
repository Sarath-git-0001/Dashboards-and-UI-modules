<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EduSafeGuard ‚Äî Admin Dashboard</title>
<link rel="stylesheet" href="styles.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
.upload-row { display: flex; gap: 16px; }
.upload-row > * { flex: 1; }

.ml-processing-bar {
  height: 4px;
  background: var(--surface);
  border-radius: 999px;
  overflow: hidden;
  margin: 12px 0;
}
.ml-processing-fill {
  height: 100%;
  width: 0%;
  border-radius: 999px;
  background: linear-gradient(90deg, var(--cyan), var(--teal), var(--indigo));
  transition: width 0.3s ease;
}

.student-row-expand {
  background: rgba(56,189,248,0.04);
  border-top: 1px solid var(--border);
}
.student-row-expand td {
  padding: 16px;
}
.mini-chart {
  display: flex;
  align-items: flex-end;
  gap: 3px;
  height: 30px;
}
.mini-bar {
  flex: 1;
  border-radius: 3px 3px 0 0;
  min-height: 3px;
  transition: var(--transition);
}
.mini-bar:hover { opacity: 0.8; }

.section-pill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px; height: 28px;
  border-radius: 7px;
  font-size: 0.72rem;
  font-weight: 700;
  border: 1px solid;
}
.section-pill.A { background: rgba(56,189,248,0.12); border-color: rgba(56,189,248,0.25); color: var(--cyan); }
.section-pill.B { background: rgba(167,139,250,0.12); border-color: rgba(167,139,250,0.25); color: var(--violet); }
.section-pill.C { background: rgba(45,212,191,0.12); border-color: rgba(45,212,191,0.25); color: var(--teal); }

.action-modal .modal { max-width: 560px; }

.upload-preview {
  background: var(--surface);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  overflow: hidden;
  margin-top: 14px;
}
.upload-preview-header {
  padding: 10px 14px;
  background: rgba(255,255,255,0.03);
  border-bottom: 1px solid var(--border);
  font-size: 0.78rem;
  color: var(--text-dim);
  display: flex;
  justify-content: space-between;
}
.upload-preview-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  padding: 8px 14px;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  font-size: 0.78rem;
  color: var(--text-secondary);
}
.upload-preview-row:last-child { border-bottom: none; }

.filter-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.chart-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 20px;
  margin-bottom: 28px;
}
@media (max-width:1200px){ .chart-grid { grid-template-columns: 1fr 1fr; } }
@media (max-width:900px){ .chart-grid { grid-template-columns: 1fr; } }

.chart-card {
  background: var(--navy-mid);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
}

.notification-panel {
  position: fixed;
  top: 74px;
  right: 16px;
  width: 320px;
  background: var(--navy-mid);
  border: 1px solid var(--border-strong);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  z-index: 200;
  display: none;
  max-height: 500px;
  overflow-y: auto;
}
.notification-panel.show { display: block; }

.notif-header {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.notif-item {
  padding: 12px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  cursor: pointer;
  transition: var(--transition);
}
.notif-item:hover { background: rgba(255,255,255,0.025); }
.notif-item h4 { font-size: 0.82rem; font-weight: 600; color: var(--text-primary); margin-bottom: 3px; }
.notif-item p { font-size: 0.76rem; color: var(--text-dim); }
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-brand">
    <div class="shield">üõ°Ô∏è</div>
    EduSafeGuard
  </div>
  <div style="font-size:0.78rem; color:var(--text-dim);">
    Greenfield Engineering College &nbsp;¬∑&nbsp; <span style="color:var(--cyan)">Admin Portal</span>
  </div>
  <div class="topbar-actions">
    <div style="position:relative; display:inline-block">
      <button class="btn-icon" onclick="toggleNotifs()" title="Notifications">üîî</button>
      <div class="notif-dot"></div>
    </div>
    <div class="user-chip">
      <div class="avatar">A</div>
      Admin ¬∑ ADM-GFC-2025
    </div>
    <a href="login.html" class="btn-logout">Logout</a>
  </div>
</div>

<!-- NOTIFICATION PANEL -->
<div class="notification-panel" id="notif-panel">
  <div class="notif-header">
    <span style="font-size:0.85rem;font-weight:700;">Notifications</span>
    <span style="font-size:0.75rem;color:var(--cyan);cursor:pointer;">Mark all read</span>
  </div>
  <div class="notif-item">
    <h4>üö® 12 Students at HIGH Risk</h4>
    <p>ML model flagged after this week's upload ¬∑ 2h ago</p>
  </div>
  <div class="notif-item">
    <h4>üìä Attendance Upload Processed</h4>
    <p>Week 14 data for 482 students ¬∑ 2h ago</p>
  </div>
  <div class="notif-item">
    <h4>‚ö†Ô∏è Section B - Low Avg Marks</h4>
    <p>Average marks dropped to 46% ¬∑ 1 day ago</p>
  </div>
  <div class="notif-item">
    <h4>üìã Marks Upload Complete</h4>
    <p>Mid-semester marks for 3 subjects ¬∑ 3 days ago</p>
  </div>
</div>

<!-- APP SHELL -->
<div class="app-shell">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-section-label">Overview</div>
    <div class="sidebar-link active" onclick="showPage('overview')">
      <div class="icon">üìä</div> Dashboard
    </div>
    <div class="sidebar-link" onclick="showPage('students')">
      <div class="icon">üéì</div> All Students
    </div>
    <div class="sidebar-link" onclick="showPage('risk')">
      <div class="icon">üö®</div> Risk Report
      <span class="badge">12</span>
    </div>

    <div class="sidebar-section-label" style="margin-top:12px">Data</div>
    <div class="sidebar-link" onclick="showPage('upload-attendance')">
      <div class="icon">üìÖ</div> Upload Attendance
    </div>
    <div class="sidebar-link" onclick="showPage('upload-marks')">
      <div class="icon">üìã</div> Upload Marks
    </div>

    <div class="sidebar-section-label" style="margin-top:12px">Administration</div>
    <div class="sidebar-link" onclick="showPage('sections')">
      <div class="icon">üèõÔ∏è</div> Sections
    </div>
    <div class="sidebar-link" onclick="showPage('counselors')">
      <div class="icon">üßë‚Äçüè´</div> Counselors
    </div>
    <div class="sidebar-link" onclick="showPage('settings')">
      <div class="icon">‚öôÔ∏è</div> Settings
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">

    <!-- PAGE: OVERVIEW DASHBOARD -->
    <div id="page-overview">
      <div class="page-header">
        <h1>Admin Dashboard</h1>
        <p>Institution overview ¬∑ Week 14 ¬∑ Academic Year 2025‚Äì26</p>
      </div>

      <!-- STAT CARDS -->
      <div class="stats-grid">
        <div class="stat-card cyan">
          <div class="stat-icon">üéì</div>
          <div class="stat-label">Total Students</div>
          <div class="stat-value">482</div>
          <div class="stat-sub">Across 3 branches, 3 sections</div>
          <div class="stat-trend up">‚ñ≤ +12 this semester</div>
        </div>
        <div class="stat-card rose">
          <div class="stat-icon">üö®</div>
          <div class="stat-label">High Risk Students</div>
          <div class="stat-value">12</div>
          <div class="stat-sub">Need immediate counseling</div>
          <div class="stat-trend down">‚ñ≤ +3 since last week</div>
        </div>
        <div class="stat-card amber">
          <div class="stat-icon">‚ö†Ô∏è</div>
          <div class="stat-label">Medium Risk</div>
          <div class="stat-value">37</div>
          <div class="stat-sub">Being monitored</div>
          <div class="stat-trend down">‚ñ≤ +7 since last week</div>
        </div>
        <div class="stat-card emerald">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-label">Low Risk</div>
          <div class="stat-value">433</div>
          <div class="stat-sub">Performing well</div>
          <div class="stat-trend up">89.8% of students</div>
        </div>
        <div class="stat-card indigo">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-label">Avg Attendance</div>
          <div class="stat-value">78<span style="font-size:1.2rem">%</span></div>
          <div class="stat-sub">Institution average</div>
          <div class="stat-trend up">‚ñ≤ +2% from last week</div>
        </div>
      </div>

      <!-- CHARTS ROW -->
      <div class="chart-grid">
        <!-- Donut: Risk Distribution -->
        <div class="chart-card">
          <div class="card-header" style="padding:0 0 14px 0;border:none">
            <div class="card-title">Risk Distribution</div>
            <span class="chip">This Week</span>
          </div>
          <div style="height:200px; position:relative">
            <canvas id="riskDonut"></canvas>
          </div>
          <div style="display:flex;gap:12px;justify-content:center;margin-top:14px;flex-wrap:wrap;">
            <div style="display:flex;align-items:center;gap:5px;font-size:0.76rem;color:var(--text-dim)"><div style="width:10px;height:10px;border-radius:50%;background:var(--risk-high)"></div>High (12)</div>
            <div style="display:flex;align-items:center;gap:5px;font-size:0.76rem;color:var(--text-dim)"><div style="width:10px;height:10px;border-radius:50%;background:var(--risk-med)"></div>Med (37)</div>
            <div style="display:flex;align-items:center;gap:5px;font-size:0.76rem;color:var(--text-dim)"><div style="width:10px;height:10px;border-radius:50%;background:var(--risk-low)"></div>Low (433)</div>
          </div>
        </div>

        <!-- Bar: Section Performance -->
        <div class="chart-card">
          <div class="card-header" style="padding:0 0 14px 0;border:none">
            <div class="card-title">Section-wise Avg Marks</div>
            <span class="chip">Mid-Sem</span>
          </div>
          <div style="height:200px; position:relative">
            <canvas id="sectionBar"></canvas>
          </div>
        </div>

        <!-- Line: Attendance Trend -->
        <div class="chart-card">
          <div class="card-header" style="padding:0 0 14px 0;border:none">
            <div class="card-title">Weekly Attendance Trend</div>
            <span class="chip">14 Weeks</span>
          </div>
          <div style="height:200px; position:relative">
            <canvas id="attendanceLine"></canvas>
          </div>
        </div>
      </div>

      <!-- CRITICAL STUDENTS TABLE -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üö® Critical Students ‚Äî Immediate Action Required</div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-sm btn-danger">Send Mass Alert</button>
            <button class="btn btn-sm btn-secondary" onclick="showPage('risk')">View All Risk ‚Üí</button>
          </div>
        </div>
        <div class="table-wrap" style="border:none;border-radius:0">
          <table>
            <thead>
              <tr>
                <th>Student</th>
                <th>Section</th>
                <th>Attendance</th>
                <th>Avg Marks</th>
                <th>Risk Score</th>
                <th>Risk Level</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="critical-table">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PAGE: ALL STUDENTS -->
    <div id="page-students" style="display:none">
      <div class="page-header">
        <h1>All Students</h1>
        <p>Complete student roster with performance overview</p>
      </div>
      <div class="filter-bar" style="margin-bottom:20px">
        <div class="search-bar" style="flex:1; max-width:320px">
          <span>üîç</span>
          <input type="text" placeholder="Search by name or roll number..." id="student-search" oninput="filterStudents()">
        </div>
        <select class="form-select" style="width:auto" onchange="filterStudents()" id="filter-branch">
          <option value="">All Branches</option>
          <option value="CSE">CSE</option>
          <option value="ECE">ECE</option>
          <option value="MECH">MECH</option>
        </select>
        <select class="form-select" style="width:auto" onchange="filterStudents()" id="filter-section">
          <option value="">All Sections</option>
          <option value="A">Section A</option>
          <option value="B">Section B</option>
          <option value="C">Section C</option>
        </select>
        <select class="form-select" style="width:auto" onchange="filterStudents()" id="filter-risk">
          <option value="">All Risk Levels</option>
          <option value="high">High Risk</option>
          <option value="medium">Medium Risk</option>
          <option value="low">Low Risk</option>
        </select>
        <button class="btn btn-secondary btn-sm">üì• Export CSV</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Roll No.</th>
              <th>Name</th>
              <th>Branch</th>
              <th>Section</th>
              <th>Attendance %</th>
              <th>Avg Marks %</th>
              <th>Risk Level</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="all-students-table"></tbody>
        </table>
      </div>
    </div>

    <!-- PAGE: RISK REPORT -->
    <div id="page-risk" style="display:none">
      <div class="page-header">
        <h1>Risk Report</h1>
        <p>AI/ML model output ¬∑ Students flagged for counseling intervention</p>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:28px">
        <div class="stat-card rose" style="cursor:pointer" onclick="filterRiskTable('high')">
          <div class="stat-label">High Risk</div>
          <div class="stat-value">12</div>
          <div class="stat-sub">Attendance &lt; 60% OR Marks &lt; 40%</div>
        </div>
        <div class="stat-card amber" style="cursor:pointer" onclick="filterRiskTable('medium')">
          <div class="stat-label">Medium Risk</div>
          <div class="stat-value">37</div>
          <div class="stat-sub">Attendance 60‚Äì70% OR Marks 40‚Äì50%</div>
        </div>
        <div class="stat-card emerald" style="cursor:pointer" onclick="filterRiskTable('')">
          <div class="stat-label">Show All</div>
          <div class="stat-value">49</div>
          <div class="stat-sub">All flagged students</div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Flagged Students ‚Äî ML Prediction Output</div>
          <button class="btn btn-sm btn-danger">üì® Alert All Counselors</button>
        </div>
        <div class="table-wrap" style="border:none;border-radius:0">
          <table>
            <thead>
              <tr>
                <th>Student</th>
                <th>Branch</th>
                <th>Attendance</th>
                <th>Marks</th>
                <th>ML Risk Score</th>
                <th>Risk Level</th>
                <th>Primary Reason</th>
                <th>Counselor</th>
              </tr>
            </thead>
            <tbody id="risk-table"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PAGE: UPLOAD ATTENDANCE -->
    <div id="page-upload-attendance" style="display:none">
      <div class="page-header">
        <h1>Upload Attendance</h1>
        <p>Upload weekly attendance data for processing by the risk engine</p>
      </div>
      <div class="grid-2">
        <div>
          <div class="card" style="margin-bottom:20px">
            <div class="card-header">
              <div class="card-title">Upload CSV / Excel</div>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">Academic Week</label>
                <select class="form-select">
                  <option>Week 14 (Feb 10‚Äì14, 2026)</option>
                  <option>Week 13 (Feb 3‚Äì7, 2026)</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Branch / Department</label>
                <select class="form-select">
                  <option>All Branches</option>
                  <option>CSE</option>
                  <option>ECE</option>
                  <option>MECH</option>
                </select>
              </div>
              <div class="upload-zone" onclick="document.getElementById('att-file').click()" id="att-drop-zone">
                <div class="upload-icon">üìÇ</div>
                <h3>Drop your file here or click to browse</h3>
                <p>Supports CSV, XLS, XLSX ¬∑ Max 10MB</p>
                <input type="file" id="att-file" style="display:none" accept=".csv,.xls,.xlsx" onchange="handleFileUpload('attendance', this)">
              </div>

              <div id="att-processing" style="display:none;margin-top:14px">
                <div style="display:flex;justify-content:space-between;font-size:0.8rem;color:var(--text-secondary);margin-bottom:4px">
                  <span id="att-proc-label">Processing...</span>
                  <span id="att-proc-pct">0%</span>
                </div>
                <div class="ml-processing-bar">
                  <div class="ml-processing-fill" id="att-proc-bar"></div>
                </div>
              </div>

              <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:14px" onclick="processUpload('attendance')">
                ‚ö° Process & Run Risk Engine
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Format Guide</div>
            </div>
            <div class="card-body">
              <div class="upload-preview">
                <div class="upload-preview-header">
                  <span>Required CSV Columns</span>
                  <button class="copy-btn" onclick="copyText('student_id,week,date,status')">Copy Header</button>
                </div>
                <div class="upload-preview-row" style="font-weight:600;color:var(--text-primary);background:rgba(255,255,255,0.03)">
                  <span>student_id</span><span>week</span><span>date</span><span>status</span>
                </div>
                <div class="upload-preview-row">
                  <span>STU-1001</span><span>14</span><span>2026-02-10</span><span>Present</span>
                </div>
                <div class="upload-preview-row">
                  <span>STU-1002</span><span>14</span><span>2026-02-10</span><span>Absent</span>
                </div>
                <div class="upload-preview-row">
                  <span>STU-1003</span><span>14</span><span>2026-02-11</span><span>Present</span>
                </div>
              </div>
              <button class="btn btn-secondary btn-sm" style="margin-top:12px">üì• Download Template</button>
            </div>
          </div>
        </div>

        <div>
          <div class="card" style="margin-bottom:20px">
            <div class="card-header">
              <div class="card-title">Upload History</div>
            </div>
            <div class="card-body" style="padding:0">
              <table>
                <thead>
                  <tr><th>Week</th><th>Records</th><th>Status</th><th>Date</th></tr>
                </thead>
                <tbody>
                  <tr><td>Week 14</td><td>2,410</td><td><span class="risk-badge low">‚úì Done</span></td><td>Feb 14, 2026</td></tr>
                  <tr><td>Week 13</td><td>2,395</td><td><span class="risk-badge low">‚úì Done</span></td><td>Feb 7, 2026</td></tr>
                  <tr><td>Week 12</td><td>2,410</td><td><span class="risk-badge low">‚úì Done</span></td><td>Jan 31, 2026</td></tr>
                  <tr><td>Week 11</td><td>2,380</td><td><span class="risk-badge medium">‚ö† Partial</span></td><td>Jan 24, 2026</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- ML Results -->
          <div class="card" id="ml-result-card" style="display:none">
            <div class="card-header">
              <div class="card-title">‚úÖ ML Engine Results</div>
            </div>
            <div class="card-body">
              <div class="alert-item info" style="margin-bottom:14px">
                <div class="alert-icon">ü§ñ</div>
                <div class="alert-body">
                  <h4>Risk Engine Completed</h4>
                  <p>482 students evaluated ¬∑ 12 HIGH ¬∑ 37 MEDIUM risk flags generated.</p>
                </div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px">
                <div style="text-align:center;padding:12px;background:var(--risk-high-bg);border-radius:var(--radius);border:1px solid rgba(239,68,68,0.2)">
                  <div style="font-size:1.6rem;font-weight:800;color:var(--rose);font-family:var(--font-display)">12</div>
                  <div style="font-size:0.72rem;color:var(--text-dim)">HIGH RISK</div>
                </div>
                <div style="text-align:center;padding:12px;background:var(--risk-med-bg);border-radius:var(--radius);border:1px solid rgba(245,158,11,0.2)">
                  <div style="font-size:1.6rem;font-weight:800;color:var(--amber);font-family:var(--font-display)">37</div>
                  <div style="font-size:0.72rem;color:var(--text-dim)">MEDIUM</div>
                </div>
                <div style="text-align:center;padding:12px;background:var(--risk-low-bg);border-radius:var(--radius);border:1px solid rgba(16,185,129,0.2)">
                  <div style="font-size:1.6rem;font-weight:800;color:var(--emerald);font-family:var(--font-display)">433</div>
                  <div style="font-size:0.72rem;color:var(--text-dim)">LOW RISK</div>
                </div>
              </div>
              <button class="btn btn-danger" style="width:100%;justify-content:center" onclick="showPage('risk')">
                View Risk Report ‚Üí
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PAGE: UPLOAD MARKS -->
    <div id="page-upload-marks" style="display:none">
      <div class="page-header">
        <h1>Upload Marks</h1>
        <p>Upload examination marks data for performance analysis</p>
      </div>
      <div class="grid-2">
        <div>
          <div class="card">
            <div class="card-header"><div class="card-title">Upload Marks Sheet</div></div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">Exam Type</label>
                <select class="form-select">
                  <option>Mid Semester Exam</option>
                  <option>End Semester Exam</option>
                  <option>Unit Test 1</option>
                  <option>Unit Test 2</option>
                  <option>Internal Assessment</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Subject</label>
                <select class="form-select">
                  <option>All Subjects</option>
                  <option>Data Structures (CS301)</option>
                  <option>Database Management (CS302)</option>
                  <option>Operating Systems (CS303)</option>
                  <option>Computer Networks (CS304)</option>
                </select>
              </div>
              <div class="upload-zone" onclick="document.getElementById('marks-file').click()">
                <div class="upload-icon">üìã</div>
                <h3>Upload Marks File</h3>
                <p>CSV, XLS, XLSX ¬∑ Max 10MB</p>
                <input type="file" id="marks-file" style="display:none" accept=".csv,.xls,.xlsx" onchange="handleFileUpload('marks', this)">
              </div>
              <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:14px" onclick="processUpload('marks')">
                ‚ö° Process & Analyze Performance
              </button>
            </div>
          </div>
        </div>
        <div>
          <div class="card">
            <div class="card-header"><div class="card-title">Marks Format Guide</div></div>
            <div class="card-body">
              <div class="upload-preview">
                <div class="upload-preview-header">
                  <span>Required CSV Columns</span>
                </div>
                <div class="upload-preview-row" style="font-weight:600;color:var(--text-primary);background:rgba(255,255,255,0.03)">
                  <span>student_id</span><span>subject</span><span>marks</span><span>max_marks</span>
                </div>
                <div class="upload-preview-row"><span>STU-1001</span><span>CS301</span><span>78</span><span>100</span></div>
                <div class="upload-preview-row"><span>STU-1002</span><span>CS301</span><span>45</span><span>100</span></div>
                <div class="upload-preview-row"><span>STU-1003</span><span>CS301</span><span>92</span><span>100</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// ---- SAMPLE DATA ----
const students = [
  { id: 'STU-1001', name: 'Arjun Kumar', branch: 'CSE', section: 'A', attendance: 58, marks: 41, risk: 'high', riskScore: 91 },
  { id: 'STU-1002', name: 'Priya Sharma', branch: 'CSE', section: 'B', attendance: 62, marks: 44, risk: 'high', riskScore: 87 },
  { id: 'STU-1003', name: 'Karthik Raj', branch: 'ECE', section: 'A', attendance: 55, marks: 38, risk: 'high', riskScore: 93 },
  { id: 'STU-1004', name: 'Meena Patel', branch: 'MECH', section: 'C', attendance: 60, marks: 42, risk: 'high', riskScore: 85 },
  { id: 'STU-1005', name: 'Rahul Singh', branch: 'CSE', section: 'A', attendance: 63, marks: 39, risk: 'high', riskScore: 88 },
  { id: 'STU-1006', name: 'Divya Reddy', branch: 'ECE', section: 'B', attendance: 59, marks: 46, risk: 'high', riskScore: 82 },
  { id: 'STU-1007', name: 'Anand Rao', branch: 'CSE', section: 'C', attendance: 67, marks: 48, risk: 'medium', riskScore: 68 },
  { id: 'STU-1008', name: 'Sneha Iyer', branch: 'MECH', section: 'A', attendance: 71, marks: 52, risk: 'medium', riskScore: 54 },
  { id: 'STU-1009', name: 'Vijay Nair', branch: 'ECE', section: 'C', attendance: 82, marks: 71, risk: 'low', riskScore: 22 },
  { id: 'STU-1010', name: 'Lakshmi Devi', branch: 'CSE', section: 'A', attendance: 91, marks: 84, risk: 'low', riskScore: 8 },
  { id: 'STU-1011', name: 'Suresh Babu', branch: 'MECH', section: 'B', attendance: 64, marks: 40, risk: 'high', riskScore: 89 },
  { id: 'STU-1012', name: 'Ramya K', branch: 'CSE', section: 'B', attendance: 78, marks: 67, risk: 'low', riskScore: 18 },
];

const reasons = {
  high: ['Low Attendance + Low Marks', 'Attendance < 60%', 'Marks < 40%', 'Declining trend'],
  medium: ['Borderline Attendance', 'Marks below threshold', 'Irregular attendance'],
  low: ['Performing well']
};

function getRiskReason(s) {
  if (s.risk === 'high') {
    if (s.attendance < 60 && s.marks < 40) return 'Low Attendance + Low Marks';
    if (s.attendance < 60) return 'Attendance < 60%';
    return 'Marks < 40%';
  }
  if (s.risk === 'medium') return 'Borderline ‚Äî monitoring';
  return 'On track';
}

function renderCriticalTable() {
  const high = students.filter(s => s.risk === 'high').slice(0, 6);
  const tbody = document.getElementById('critical-table');
  tbody.innerHTML = high.map(s => `
    <tr>
      <td><div style="font-weight:600">${s.name}</div><div style="font-size:0.75rem;color:var(--text-dim)">${s.id}</div></td>
      <td><span class="section-pill ${s.section}">${s.section}</span></td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="color:var(--rose);font-weight:600">${s.attendance}%</span>
          <div class="progress-bar-wrap" style="width:60px">
            <div class="progress-bar-fill rose" style="width:${s.attendance}%"></div>
          </div>
        </div>
      </td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="color:var(--rose);font-weight:600">${s.marks}%</span>
          <div class="progress-bar-wrap" style="width:60px">
            <div class="progress-bar-fill rose" style="width:${s.marks}%"></div>
          </div>
        </div>
      </td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-weight:600;color:var(--rose)">${s.riskScore}</span>
          <div class="progress-bar-wrap" style="width:50px">
            <div class="progress-bar-fill rose" style="width:${s.riskScore}%"></div>
          </div>
        </div>
      </td>
      <td><span class="risk-badge ${s.risk}">${s.risk}</span></td>
      <td><button class="btn btn-sm btn-danger" onclick="alertStudent('${s.name}')">üîî Alert</button></td>
    </tr>
  `).join('');
}

function renderAllStudents(filter = {}) {
  let data = students;
  const search = (document.getElementById('student-search')?.value || '').toLowerCase();
  const branch = document.getElementById('filter-branch')?.value || '';
  const section = document.getElementById('filter-section')?.value || '';
  const risk = document.getElementById('filter-risk')?.value || '';

  if (search) data = data.filter(s => s.name.toLowerCase().includes(search) || s.id.toLowerCase().includes(search));
  if (branch) data = data.filter(s => s.branch === branch);
  if (section) data = data.filter(s => s.section === section);
  if (risk) data = data.filter(s => s.risk === risk);

  const tbody = document.getElementById('all-students-table');
  if (!tbody) return;
  tbody.innerHTML = data.map(s => `
    <tr>
      <td>${s.id}</td>
      <td>${s.name}</td>
      <td><span class="chip">${s.branch}</span></td>
      <td><span class="section-pill ${s.section}">${s.section}</span></td>
      <td style="color:${s.attendance < 70 ? 'var(--rose)' : 'var(--emerald)'}; font-weight:600">${s.attendance}%</td>
      <td style="color:${s.marks < 50 ? 'var(--rose)' : 'var(--emerald)'}; font-weight:600">${s.marks}%</td>
      <td><span class="risk-badge ${s.risk}">${s.risk}</span></td>
      <td><button class="btn btn-sm btn-secondary" onclick="alertStudent('${s.name}')">View</button></td>
    </tr>
  `).join('');
}

function filterStudents() { renderAllStudents(); }

function renderRiskTable(levelFilter = '') {
  let data = students.filter(s => s.risk !== 'low');
  if (levelFilter) data = data.filter(s => s.risk === levelFilter);
  const tbody = document.getElementById('risk-table');
  if (!tbody) return;
  tbody.innerHTML = data.map(s => `
    <tr>
      <td><div style="font-weight:600">${s.name}</div><div style="font-size:0.74rem;color:var(--text-dim)">${s.id}</div></td>
      <td><span class="chip">${s.branch}</span></td>
      <td style="color:${s.attendance < 70 ? 'var(--rose)' : 'var(--amber)'};font-weight:600">${s.attendance}%</td>
      <td style="color:${s.marks < 50 ? 'var(--rose)' : 'var(--amber)'};font-weight:600">${s.marks}%</td>
      <td>
        <div style="display:flex;align-items:center;gap:6px">
          <span style="font-weight:700;color:${s.risk === 'high' ? 'var(--rose)' : 'var(--amber)'}">${s.riskScore}/100</span>
        </div>
      </td>
      <td><span class="risk-badge ${s.risk}">${s.risk}</span></td>
      <td style="font-size:0.8rem;color:var(--text-secondary)">${getRiskReason(s)}</td>
      <td><button class="btn btn-sm btn-secondary" onclick="alertStudent('${s.name}')">Assign</button></td>
    </tr>
  `).join('');
}

function filterRiskTable(level) { renderRiskTable(level); }

// PAGE NAVIGATION
const pages = ['overview', 'students', 'risk', 'upload-attendance', 'upload-marks', 'sections', 'counselors', 'settings'];
function showPage(name) {
  pages.forEach(p => {
    const el = document.getElementById(`page-${p}`);
    if (el) el.style.display = 'none';
  });
  const target = document.getElementById(`page-${name}`);
  if (target) target.style.display = 'block';

  document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));

  if (name === 'students') renderAllStudents();
  if (name === 'risk') renderRiskTable();
}

// CHARTS
function initCharts() {
  const chartDefaults = {
    color: '#94a3b8',
    font: { family: 'DM Sans', size: 11 },
  };
  Chart.defaults.color = chartDefaults.color;
  Chart.defaults.font = chartDefaults.font;

  // Risk Donut
  new Chart(document.getElementById('riskDonut'), {
    type: 'doughnut',
    data: {
      labels: ['High', 'Medium', 'Low'],
      datasets: [{
        data: [12, 37, 433],
        backgroundColor: ['rgba(239,68,68,0.8)', 'rgba(245,158,11,0.8)', 'rgba(16,185,129,0.8)'],
        borderColor: ['rgba(239,68,68,0.2)', 'rgba(245,158,11,0.2)', 'rgba(16,185,129,0.2)'],
        borderWidth: 2,
        hoverOffset: 6,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      cutout: '72%',
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.parsed} students` } } }
    }
  });

  // Section Bar
  new Chart(document.getElementById('sectionBar'), {
    type: 'bar',
    data: {
      labels: ['CSE-A', 'CSE-B', 'CSE-C', 'ECE-A', 'ECE-B', 'ECE-C', 'MECH-A', 'MECH-B', 'MECH-C'],
      datasets: [{
        label: 'Avg Marks %',
        data: [72, 61, 68, 59, 74, 65, 70, 63, 67],
        backgroundColor: ctx => {
          const v = ctx.raw;
          if (v < 60) return 'rgba(239,68,68,0.7)';
          if (v < 70) return 'rgba(245,158,11,0.7)';
          return 'rgba(56,189,248,0.7)';
        },
        borderRadius: 5,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { font: { size: 9 } } },
        y: { grid: { color: 'rgba(255,255,255,0.04)' }, min: 40, max: 100 }
      },
      plugins: { legend: { display: false } }
    }
  });

  // Attendance Line
  new Chart(document.getElementById('attendanceLine'), {
    type: 'line',
    data: {
      labels: ['W1','W2','W3','W4','W5','W6','W7','W8','W9','W10','W11','W12','W13','W14'],
      datasets: [{
        label: 'Avg Attendance %',
        data: [92, 88, 85, 87, 82, 79, 81, 77, 75, 74, 76, 78, 76, 78],
        borderColor: '#38bdf8',
        backgroundColor: 'rgba(56,189,248,0.1)',
        fill: true,
        tension: 0.4,
        pointRadius: 3,
        pointBackgroundColor: '#38bdf8',
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.04)' } },
        y: { grid: { color: 'rgba(255,255,255,0.04)' }, min: 50, max: 100 }
      },
      plugins: { legend: { display: false } }
    }
  });
}

// UPLOAD / PROCESSING SIMULATION
function handleFileUpload(type, input) {
  const file = input.files[0];
  if (!file) return;
  const zone = document.getElementById('att-drop-zone');
  if (zone) {
    zone.innerHTML = `<div class="upload-icon">‚úÖ</div><h3>${file.name}</h3><p>${(file.size/1024).toFixed(1)} KB ¬∑ Ready to process</p>`;
    zone.style.borderColor = 'var(--emerald)';
    zone.style.background = 'var(--risk-low-bg)';
  }
}

function processUpload(type) {
  const proc = document.getElementById('att-processing');
  if (proc) proc.style.display = 'block';
  const label = document.getElementById('att-proc-label');
  const pct = document.getElementById('att-proc-pct');
  const bar = document.getElementById('att-proc-bar');

  const steps = [
    [10, 'Parsing CSV...'],
    [30, 'Validating student IDs...'],
    [55, 'Computing attendance %...'],
    [75, 'Running ML risk model...'],
    [90, 'Generating alerts...'],
    [100, 'Complete ‚úÖ']
  ];

  let i = 0;
  const interval = setInterval(() => {
    if (i >= steps.length) {
      clearInterval(interval);
      if (type === 'attendance') {
        const card = document.getElementById('ml-result-card');
        if (card) card.style.display = 'block';
      }
      return;
    }
    const [p, l] = steps[i++];
    if (bar) bar.style.width = p + '%';
    if (label) label.textContent = l;
    if (pct) pct.textContent = p + '%';
  }, 600);
}

function alertStudent(name) {
  alert(`Alert sent to ${name} and their assigned counselor.`);
}

function toggleNotifs() {
  document.getElementById('notif-panel').classList.toggle('show');
}

document.addEventListener('click', e => {
  if (!e.target.closest('#notif-panel') && !e.target.closest('.btn-icon')) {
    document.getElementById('notif-panel')?.classList.remove('show');
  }
});

// INIT
renderCriticalTable();
initCharts();
</script>
</body>
</html>

